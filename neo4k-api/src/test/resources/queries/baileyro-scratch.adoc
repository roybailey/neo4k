== Reference Data ==

==== `createTimeSeries` ====

Example creation of time series nodes as per common pattern.

```
//Create Time Tree Indexes
CREATE INDEX ON :Year(value);
CREATE INDEX ON :Month(value);
CREATE INDEX ON :Day(value);

//Create Time Tree with Day Depth
WITH range(2016, 2017) AS years, range(1,12) AS months
FOREACH(year IN years |
  CREATE (y:Year {value: year})
  FOREACH(month IN months |
    CREATE (m:Month {value: month})
    MERGE (y)-[:CONTAINS]->(m)
    FOREACH(day IN (CASE
                      WHEN month IN [1,3,5,7,8,10,12] THEN range(1,31)
                      WHEN month = 2 THEN
                        CASE
                          WHEN year % 4 <> 0 THEN range(1,28)
                          WHEN year % 100 = 0 AND year % 400 = 0 THEN range(1,29)
                          ELSE range(1,28)
                        END
                      ELSE range(1,30)
                    END) |
      CREATE (d:Day {value: day})
      MERGE (m)-[:CONTAINS]->(d))))
```


==== `createTimeSeries` ====

Find node timestamp dates, create time-series node representing date and the relationship to date node.

```
match (ts:TimeSeries)
optional match (n)-[r]-(ts)
delete r, ts
```

```
// Customer Created Time-Series
match (c:Customer)
where c.CREATED_DATE_TIME is not null
with c, replace(left(c.CREATED_DATE_TIME,10),'/','') as dateCreated
with dateCreated, c
merge (ts:TimeSeries {value: dateCreated})
merge (c)-[r:CREATED]->(ts)
return count(r)

// Investment Created Time-Series
match (i:Investment {STATUS: 'ACTIVE'})-[:BELONGS_TO]->(c:Customer)
where c.CREATED_DATE_TIME is not null and i.CREATED_DATE_TIME is not null
with i, replace(left(i.CREATED_DATE_TIME,10),'/','') as dateCreated
with dateCreated, i
merge (ts:TimeSeries {value: dateCreated})
merge (i)-[r:CREATED]->(ts)
return count(r)

// Investment Funded Time-Series
match (i:Investment {STATUS: 'ACTIVE'})-[:BELONGS_TO]->(c:Customer)
where c.CREATED_DATE_TIME is not null and i.CREATED_DATE_TIME is not null and i.FUNDED_DATE is not null
with i, replace(left(i.FUNDED_DATE,10),'/','') as dateCreated
with dateCreated, i
merge (ts:TimeSeries {value: dateCreated})
merge (i)-[r:FUNDED]->(ts)
return count(r)
```

Verify the counts of time-series node relationships.

```
// Verify Customer Create Counts
match (ts:TimeSeries)
optional match (c:Customer)-[:CREATED]->(ts)
return ts.value as date, count(c) as total
order by date

// Verify Investment Create Counts
match (i:Investment {STATUS: 'ACTIVE'})--(c:Customer)
where c.CREATED_DATE_TIME is not null and i.CREATED_DATE_TIME is not null
with i, replace(left(i.CREATED_DATE_TIME,10),'/','') as dateCreated
with dateCreated, i
return dateCreated, count(i)
order by dateCreated

// Verify Investment Funded Counts
match (i:Investment {STATUS: 'ACTIVE'})--(c:Customer)
where c.CREATED_DATE_TIME is not null and i.CREATED_DATE_TIME is not null and i.FUNDED_DATE is not null
with i, replace(left(i.FUNDED_DATE,10),'/','') as dateFunded
with dateFunded, i
return dateFunded, count(i)
order by dateFunded
```

Add attribute to time-series as total connections.

```
// Customer Created Count Time-Series
match (ts:TimeSeries)
optional match (c:Customer)-[:CREATED]->(ts)
with ts, count(c) as totalCustomers
 set ts.totalCustomers = totalCustomers

// Investment Created Count Time-Series
match (ts:TimeSeries)
optional match (i:Investment)-[:CREATED]->(ts)
with ts, count(i) as totalInvestments
 set ts.totalInvestments = totalInvestments

// Investment Funded Count Time-Series
match (ts:TimeSeries)
optional match (i:Investment)-[:FUNDED]->(ts)
with ts, count(i) as totalFundedInvestments
 set ts.totalFundedInvestments = totalFundedInvestments
```

Loop over time-series nodes accumulating totals over time.

```
// Enrich time-series nodes with accumulating totals over time
match (ts:TimeSeries)
where ts.value is not null
with ts.value as date
order by date desc
with date
match (ts:TimeSeries) where ts.value <= date
with date,
    sum(ts.totalCustomers) as totalCustomersOverTime,
    sum(ts.totalInvestments) as totalInvestmentsOverTime,
    sum(ts.totalFundedInvestments) as totalFundedInvestmentsOverTime
match (ts:TimeSeries)
where ts.value = date
set ts.totalCustomersOverTime = totalCustomersOverTime
set ts.totalInvestmentsOverTime = totalInvestmentsOverTime
set ts.totalFundedInvestmentsOverTime = totalFundedInvestmentsOverTime
```

```
match (ts:TimeSeries)
return ts.value, ts.totalCustomers, ts.totalCustomersOverTime
order by ts.value
```
